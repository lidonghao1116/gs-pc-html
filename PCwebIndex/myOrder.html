<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="css/head-foot.css" rel="stylesheet" type="text/css" />
<link href="css/myReservation.css" rel="stylesheet" type="text/css" />
<link href="css/myOrder.css" rel="stylesheet" type="text/css" />
<script src="js/jquery-1.11.3.min.js" type="text/javascript"></script>
<script type="text/javascript" src="js/top.js"></script>
<script type="text/javascript" src="js/myOrder.js"></script>
<script type="text/javascript" src="js/jquery.pagination.js"></script>
<title>家策好服务-我的订单</title>
</head>
<body>
	<!--头部-->
	<div class="head_box">
		<div class="head">
			<div class="left logo">
				<a  target="_self">
					<img src="img/logo0.png"/>
				</a>
			</div>
			<div class="left more_s">
				<select>
					<option>更多导航</option>
					<option>更多导航0</option>
					<option>更多导航1哈</option>
				</select>
			</div>
			<div class="right head_r">
				<ul>
					<li><a >登录</a></li>
					<li><a >退出</a></li>
					<li><a >我的预约</a></li>
					<li><a >我的账户</a></li>
					<li class="wechat"><a>官网微信</a>
						<div class="wechat_b">
						</div>
					</li>
				</ul>
			</div>
		</div>
	</div>
	<!--主要内容-->
	<div class="content_b">
		<div class="content_nav clearfix">
			<p>个人中心</p>
			<ul>
				<li>
					<a href="myReservation.html" target="_self">我的预约</a>
				</li>
				<li><a class="active" href="myOrder.html" target="_self">我的订单</a></li>
				<li><a href="myProfile.html" target="_self">我的账户</a></li>
			</ul>
			<a class="back_in" href="jiacerIndex.html">回到首页<img src="img/indexbg.png"/></a>
		</div>
	</div>
	<div class="main_content mine_content">
		<ul class="content_tab">
			<li class="active" data-stuCode="05">全部订单</li>
			<li data-stuCode="01">待支付</li>
			<li data-stuCode="02">待面试</li>
			<li data-stuCode="03">已完成</li>
			<li data-stuCode="04">已取消</li>
		</ul>
		<div class="line"></div>
		<ul class="info_title">
			<li class="first">订单详情</li>
			<li>服务对象</li>
			 <li class="tt_width">订单价格</li> 
			<li>订单状态</li>
			<li class="tt_width">交易流程</li>
			<li>操作</li>
		</ul>
		<div id="orderList">
		</div>
		<div id="pagination">

		</div>
	</div>
	<!--底部-->
	<!-- <div class="foot_box">
		<div class="foot">Copyright@2016上海家策教育科技有限公司<a href="http://www.miitbeian.gov.cn" target="_blank">沪ICP备16022947号-1</a></div>
	</div> -->
	<iframe scrolling="no" src="footer.html" width="100%" frameborder="0" height="270px"></iframe>
	<!--取消订单弹窗-->
	<div class="mask">
		<div class="alert">
			<input type="hidden" value="" name="orderStatus" />
			<input type="hidden" value="" name="orderNo" />
			<input type="hidden" value="" name="counterFee" />
			<input type="hidden" value="" name="tradeAmount" />
			<a class="close"></a>
			<h1>选择取消原因</h1>
			<div class="cancel_tt">
				<!-- <h2>确定要取消订单吗？取消订单后，不能恢复。</h2> -->
			</div>
			<ul class="cancel_r clearfix">
				<li class="">不想要了</li>
				<li>家政公司不能满足需求</li>
				<li>已经找到阿姨</li>
				<li>没有合适的阿姨</li>
				<li>需求填错，重新下单</li>
				<li class="other">其他原因</li>
			</ul>
			<textarea name="reason" placeholder="请输入取消原因"></textarea>
			<div class="alert_bt">
				<button class="cancel">再想想</button>
				<button class="ok">确定</button>
			</div>
		</div>
	</div>
</body>
<script type="text/javascript">
			var	pageNumber = 1;
				var pageSize = 6;
				function pagination(records) {
					$("#pagination").pagination(records, {
						num_edge_entries: 1,
						num_display_entries: 4,
						current_page: pageNumber - 1,
						items_per_page: pageSize,
						prev_text: "上一页",
						next_text: "下一页",
						callback: page_index
					});
				};
				function page_index(page_index){
				var pageNumber = page_index+1;
				var orderstatus="05";
				$(".content_tab li").each(function(){
					if($(this).hasClass("active")){
						orderstatus=$(this).attr("data-stuCode");
					}
				})
				myOrders(pageNumber,pageSize,orderstatus);
			};

				function myOrders(pageNumber,pageSize,stuCode) {
					$.ajax({
						url: publicPath + "/order/api/orders/list",
						type: "get",
						data: {
							pageNumber: pageNumber,
							pageSize: pageSize,
							orderstatus: stuCode
						},
						dataType: "json",
						async:false,
						success: function success(data) {
							if(data.success) {
								if(data.code == 0) {
									var dataJD = data.jsonData.rows;
									if(dataJD.length > 0){
										var html = "";
										$.each(dataJD, function(i, item) {

										var headImage = "";
										var staffName = "";
										var basicinfo = "";
										if(item.staffId!=""&&item.staffId!=null){
											headImage = item.staffInfo.headImage;
											if (item.staffInfo.sex == "01") {
											staffName = item.staffInfo.staffName.split("")[0] + "师傅";
											} else if (item.staffInfo.sex == "02") {
											staffName = item.staffInfo.staffName.split("")[0] + "阿姨";
											}
											basicinfo = "<p>"+item.staffInfo.age+"岁 | 属"+item.staffInfo.zodiacValue+" | "+item.staffInfo.nativePlaceValue+"人 | "+item.staffInfo.constellationValue+" | "+item.staffInfo.educationValue+"</p>";
										}else{
											headImage = "img/dzstaff.png";
											staffName = "服务定制";
											basicinfo = "";
										}
										
										var phone0 = item.orderCustomer.memberMobile.substr(0,3);
										var phone1 = item.orderCustomer.memberMobile.substr(7,11);
										var orderStatus = "";
										var pay = "";
										var orderStatusValue = "";
										if (item.orderStatus=="01") {
											orderStatusValue = "待定金";
											orderStatus="<p>定金 > 面试 > 尾款</p>"+
														"<p class='p_status'>定金：¥ "+RetainedDecimalPlaces(item.orderDeposit)+"</p>";
											pay="<p><a class='pay_bt' data-sum='"+item.orderDeposit+"' data-orderno='"+item.orderNo+"' data-orderstatus='" + item.orderStatus + "' data-totalPrice='" + item.totalPrice + "'>支付定金</a></p>"+
												"<p><a class='cancel_bt' data-orderno='"+item.orderNo+"' data-orderstatus='" + item.orderStatus + "'>取消订单</a></p>";
											
										} else if (item.orderStatus=="02") {
											orderStatusValue = "待面试";
											orderStatus="<p>定金 > 面试 > 尾款</p>"+
														"<p class='p_status'>待面试</p>";
											pay="<p><a class='cancel_bt' data-orderno='"+item.orderNo+"' data-orderdeposit='"+item.orderDeposit+"' data-orderstatus='" + item.orderStatus + "'>取消订单</a></p>";
										} else if (item.orderStatus=="03") {
											orderStatusValue = "待尾款";
											orderStatus="<p>定金 > 面试 > 尾款</p>"+
														"<p class='p_status'>尾款：¥ "+RetainedDecimalPlaces(item.orderBalance)+"</p>";
											pay="<p><a class='pay_bt' data-sum='"+item.orderBalance+"' data-orderno='"+item.orderNo+"' data-orderstatus='" + item.orderStatus + "' data-totalPrice='" + item.totalPrice + "'>支付尾款</a></p>"+
												"<p><a class='cancel_bt' data-orderno='"+item.orderNo+"' data-orderdeposit='"+item.orderDeposit+"' data-orderstatus='" + item.orderStatus + "'>取消订单</a></p>";
										} else if (item.orderStatus=="04") {
											orderStatusValue = "已完成";
										} else if (item.orderStatus=="05") {
											orderStatusValue = "已取消";
										} else if (item.orderStatus=="06") {
											orderStatusValue = "待退款";
										} else if (item.orderStatus=="08") {
											orderStatusValue = "待更换阿姨";
										}
										var totalPrice = "";
										if(item.serviceCharge!=null && item.serviceCharge!="" && item.amount!=null && item.amount!=""){
												totalPrice ="<p class='p_top'>￥"+RetainedDecimalPlaces(item.totalPrice)+"</p>"+
														"<p class='p_grey'>（阿姨工资+服务费）</p>";
										}else if(item.serviceCharge!=null && (item.amount==null||item.amount=="")){
											totalPrice ="<p class='p_top'>￥"+RetainedDecimalPlaces(item.totalPrice)+"</p>"+
														"<p class='p_grey'>（服务费）</p>";
										}else if((item.serviceCharge==null || item.serviceCharge=="") && item.amount!=null){
											totalPrice ="<p class='p_top'>￥"+RetainedDecimalPlaces(item.totalPrice)+"</p>"+
														"<p class='p_grey'>（阿姨工资）</p>";
										}else{
											totalPrice ="<p class='p_top'>￥"+RetainedDecimalPlaces(item.totalPrice)+"</p>";
										}
										
										html+="<table class='orderlist'>"+
												"<tr>"+
													"<th colspan='7'>"+
														"<p class='left'><a class='link_index' href='http://"+window.location.host+"/"+item.tenantInfo.domain+"/index.html"+"'>"+item.tenantInfo.websiteName+"</a><span>"+item.orderTime+"</span></p>"+
														"<p class='right'>订单编号："+item.orderNo+"</p>"+
													"</th>"+
												"</tr>"+
												"<tr>"+
													"<td class='first'>"+
														"<div class='staff_info'>"+
															"<img src='"+ headImage +"'/>"+
															"<div class='r_staff_info'>"+
																"<h3>"+item.serviceItemCodeValue+"</h3>"+
																"<h4>"+staffName+"</h4>"+
																basicinfo+
															"</div>"+ 
														"</div>"+
													"</td>"+
													"<td>"+
														"<p class='p_top'><span class='memeber'>"+item.orderCustomer.memberName+"</span></p>"+
														"<p>"+phone0+" **** "+phone1+"</p>"+
													"</td>"+
													"<td class='tt_width'>"+
														totalPrice+
													"</td>"+
													"<td>"+
														"<p>"+orderStatusValue+"</p>"+
														"<p><a class='details' data-domain='"+item.tenantInfo.domain+"' data-orderno='"+item.orderNo+"' target='_blank'>订单详情</a></p>"+
													"</td>"+
													"<td class='tt_width'>"+
														orderStatus+
													"</td>"+
													"<td>"+
														pay+
													"</td>"+
												"</tr>"+
											"</table>";
											
										});
										$("#orderList").html(html);
										$("#pagination").show();
									}else{
										$("#pagination").hide();
										$("#orderList").html("<div class='no_found'><p>暂无内容，去看看其他的吧~</p></div>");
									}
									
									console.log(data.msg);
								} else {
									console.log(data.msg);
								}
							} else {
								console.log(data.msg);
							}
						}
					});
				};
				$(function(){
					
					$.ajax({
						url: publicPath +"/order/api/orders/list",
						type: "get",
						data: {
							pageNumber: pageNumber,
							pageSize: pageSize,
							orderstatus:"05"},
						dataType: "json",
						async:false,
						success: function success(data) {
							if(data.success) {
								if(data.code == 0) {
									var dataJD = data.jsonData;
									pagination(dataJD.records);
									console.log(data.msg);
								} else{
									console.log(data.msg);
								}
							}
						}
					});
				})

				$(".content_tab li").click(function(){
					$(".content_tab  li ").removeClass("active");
					$(this).addClass("active");
					var orderstatus = $(this).attr("data-stuCode");
					$.ajax({
						url: publicPath + "/order/api/orders/list",
						type: "get",
						data: {
							orderstatus: orderstatus
						},
						dataType: "json",
						async:false,
						success: function success(data) {
							if(data.success) {
								if(data.code == 0) {
									var dataJD = data.jsonData;
									pagination(dataJD.records);
									console.log(data.msg);
								} else {
									console.log(data.msg);
								}
							} else {
								console.log(data.msg);
							}
						}
					});
				})
				//订单取消
				$("#orderList").on("click",".cancel_bt",function(){
					var orderNo=$(this).attr("data-orderNo");
					var orderstatus = $(this).attr("data-orderstatus");
					$(".alert input[name='orderStatus']").val(orderstatus);
					$(".alert input[name='orderNo']").val(orderNo);
					
					$(".alert .promt").remove();
					var html = "";
					if(orderstatus=="01"){
						html = "<h2>确定要取消订单吗？取消订单后，不能恢复。</h2>";
					}else{
						
						var feeRatio=0;
						var handlingFee=parseFloat($(this).attr("data-orderdeposit"))*parseFloat(feeRatio);
						var reallyFee=parseFloat($(this).attr("data-orderdeposit"))-handlingFee;
						$(".alert input[name='counterFee']").val(handlingFee);
						$(".alert input[name='tradeAmount']").val(reallyFee);
						html = "<h2>取消订单后，系统将扣取已支付金额的0%作为手续费，剩余金额将 按原路径退回。</h2>"+
								"<div class='money clearfix'>"+
									"<img src='img/leftbg.png' class='left_bg' />"+
									"<img src='img/rightbg.png' class='right_bg'/>"+
									"<p class='left'>退款手续费：<span>￥"+handlingFee+"</span></p>"+
									"<p class='left'>实际到账：<span>￥"+reallyFee+"</span></p>"+
								"</div>";
					}
					$(".cancel_tt").html(html);
					$(".mask").show();
				})
				//取消确定
				$(".ok").click(function(){
					var orderStatus = $(".alert input[name='orderStatus']").val();
					var orderNo = $(".alert input[name='orderNo']").val();
					var cancelReason ="";
					if($(".cancel_r li.active").length<1){
						$(".alert .promt").remove();
						$(".alert textarea").after("<p class='promt'>原因不能为空</p>");
					return;
					}else if($(".cancel_r li.active").hasClass("other") && $(".alert textarea").val().trim()==""){
						$(".alert .promt").remove();
						$(".alert textarea").after("<p class='promt'>原因不能为空</p>");
						return;
					}else if($(".cancel_r li.active").hasClass("other") && $(".alert textarea").val().trim().length>200){
						$(".alert .promt").remove();
						$(".alert textarea").after("<p class='promt'>原因不能超过200字</p>");
						return;
					}else{
						$(".alert .promt").remove();
					}
					if($(".cancel_r li.active").hasClass("other")){
						cancelReason = $(".alert textarea").val();
					}else{
						cancelReason = $(".cancel_r li.active").text();
					}
					var params0 = "";
					if(orderStatus=="01"){
						params0 = {
							orderNo:orderNo,
							cancleReason:cancelReason,
							counterFee:"",
							tradeAmount:""
						}
					}else{
						var tradeAmount = $(".alert input[name='tradeAmount']").val();
						var counterFee = $(".alert input[name='counterFee']").val();
						params0 = {
							orderNo:orderNo,
							cancleReason:cancelReason,
							counterFee:counterFee,
							tradeAmount:tradeAmount
						}
					}
					$.ajax({
						url: publicPath+"/order/api/orders/cancelorder",
						type: "post",
						data: params0,
						dataType: "json",
						success: function success(data) {
							if(data.success) {
								if(data.code == 0) {
									window.location.reload();
									console.log(data.msg);
								} else {
									console.log(data.msg);
								}
							} else {
								console.log(data.msg);
							}
						}
					});
			})
				
				//关闭弹窗
				$(".alert_bt .cancel,.close").click(function(){
					$(".mask").hide();
					$(".alert .promt").remove();
				});
				//订单详情
				$("#orderList").on("click",".details",function(){
					var orderNo=$(this).attr("data-orderNo");
					var domain=$(this).attr("data-domain");
					location.href="http://"+window.location.host+"/"+domain+"/orderDetail.html?orderNo="+orderNo;
				})
				//定金支付
				$("#orderList").on("click",".pay_bt",function(){
				var orderNo = $(this).attr("data-orderNo");
				var orderStatus = $(this).attr("data-orderstatus");
				var order_amount = Encrypt($(this).attr("data-totalprice"),"");
				var pay_amount = Encrypt($(this).attr("data-sum"),"");
					// pay_amount = pay_dj;
				location.href="orderPay.html?orderNo="+orderNo+"&orderAmount="+order_amount+"&orderStatus="+orderStatus+"&payAmount="+pay_amount
			})
			$(".cancel_r li").click(function(){
				$(this).addClass("active").siblings().removeClass("active");
				if($(this).hasClass("other")){
					$(".alert textarea").css("display","block");
				}else{
					$(".alert textarea").hide();
				}
			})
</script>
</html>
